<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search Appointments</title>
    <style>
        * { box-sizing: border-box; }
        html, body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(45deg, #1a1a1a, #2c2c2c);
            color: #fff;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .search-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin: 0 0 20px;
            color: #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #3498db;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 16px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .return-btn {
            background: #2ecc71;
        }

        .return-btn:hover {
            background: #27ae60;
        }

        .appointment-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .update-btn { background: #e67e22; }
        .update-btn:hover { background: #d35400; }
        .delete-btn { background: #e74c3c; }
        .delete-btn:hover { background: #c0392b; }

        #searchMessage {
            margin-top: 20px;
            text-align: center;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-card">
            <h2>Search Appointments</h2>
            <form id="searchForm">
                <div class="form-group">
                    <input type="text" 
                           id="car_plate" 
                           class="form-control"
                           placeholder="Enter car plate number (e.g., A123456)" 
                           pattern="[A-Za-z][0-9]{1,6}"
                           minlength="2" 
                           maxlength="7"
                           required>
                </div>
                <div class="button-group">
                    <button type="submit">Search</button>
                    <button type="button" class="return-btn" onclick="window.location.href='/appointment.html'">
                        Book New Appointment
                    </button>
                </div>
            </form>
            <div id="searchResults"></div>
            <div id="searchMessage"></div>
        </div>
    </div>

    <script>
        const carPlateInput = document.getElementById('car_plate');

        carPlateInput.addEventListener('keydown', function (e) {
            const value = carPlateInput.value;
            if (value.length === 0 && !e.key.match(/^[a-zA-Z]$/)) {
                e.preventDefault();
            }
            if (value.length > 0 && !e.key.match(/^[0-9]$/) && e.key.length === 1) {
                e.preventDefault();
            }
        });

        carPlateInput.addEventListener('input', function () {
            let value = carPlateInput.value.toUpperCase();
            value = value.replace(/[^A-Z0-9]/g, '');
            if (value.length > 0) {
                const firstChar = value[0];
                if (!firstChar.match(/[A-Z]/)) {
                    value = '';
                } else {
                    const digitsOnly = value.slice(1).replace(/[^0-9]/g, '');
                    value = firstChar + digitsOnly;
                }
            }
            if (value.length > 7) {
                value = value.slice(0, 7);
            }
            carPlateInput.value = value;
        });

        // Your existing handleUpdateClick and search form logic...


    document.addEventListener('DOMContentLoaded', function() {
        fetch('/auth/status', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            initializeSearchForm();
        })
        .catch(error => {
            window.location.href = '/login.html';
        });
    });

    function initializeSearchForm() {
        const searchForm = document.getElementById('searchForm');
        
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const carPlate = document.getElementById('car_plate').value.trim().toUpperCase();
            
            fetch(`/appointment/search?car_plate=${encodeURIComponent(carPlate)}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayAppointments(data.appointments, carPlate);
                } else {
                    showNoResults(carPlate);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNoResults(carPlate);
            });
        });
    }

    function displayAppointments(appointments, carPlate) {
        const searchResults = document.getElementById('searchResults');
        const searchMessage = document.getElementById('searchMessage');
        searchResults.innerHTML = '';
        searchMessage.innerHTML = '';
        
        if (!appointments.length) {
            showNoResults(carPlate);
            return;
        }
        
        appointments.forEach(appointment => {
            const div = document.createElement('div');
            div.className = 'appointment-card';
            div.innerHTML = `
                <p><strong>Date:</strong> ${formatDate(appointment.Date)}</p>
                <p><strong>Time:</strong> ${appointment.Time}</p>
                <p><strong>Car Plate:</strong> ${appointment.Car_plate}</p>
                <p><strong>Services:</strong> ${appointment.Services || 'No services'}</p>
                <p><strong>Notes:</strong> ${appointment.Notes || 'No notes'}</p>
                <div class="button-group">
                    <button class="update-btn" onclick="handleUpdateClick(${appointment.Appointment_id})">Update</button>
                    <button class="delete-btn" onclick="handleDeleteClick(${appointment.Appointment_id})">Delete</button>
                </div>
            `;
            searchResults.appendChild(div);
        });
    }

    function showNoResults(carPlate) {
        const searchResults = document.getElementById('searchResults');
        const searchMessage = document.getElementById('searchMessage');
        searchResults.innerHTML = '';
        searchMessage.innerHTML = `
            <div class="no-results">
                <p>No appointments found for car plate: ${carPlate}</p>
                <button class="book-btn" onclick="window.location.href='/appointment.html'">
                    Book New Appointment
                </button>
            </div>
        `;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }


function handleUpdateClick(appointmentId) {
    // Get today's date at start of day for comparison
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // First check if the appointment is in the past
    fetch(`/appointments/${appointmentId}`, {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const apptDate = new Date(data.appointment.Date);
            apptDate.setHours(0, 0, 0, 0);
            
            if (apptDate < today) {
                alert('Cannot update appointments from past dates');
                return;
            }
            
            // If not in past, proceed with update
            return fetch('/appointments/select', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    appointment_id: appointmentId
                }),
                credentials: 'include'
            });
        } else {
            throw new Error('Failed to fetch appointment details');
        }
    })
    .then(response => {
        if (!response) return; // If we returned early due to past date
        return response.json();
    })
    .then(data => {
        if (!data) return; // If we returned early due to past date
        if (data.status === 'success') {
            window.location.href = '/updateAppointment.html';
        } else {
            throw new Error(data.message || 'Failed to select appointment');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error selecting appointment: ' + error.message);
    });
}

function handleDeleteClick(appointmentId) {
    if (!confirm('Are you sure you want to delete this appointment?')) {
        return;
    }

    fetch(`/appointments/${appointmentId}`, {
        method: 'DELETE',
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Refresh the search results
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        } else {
            alert(data.message || 'Error deleting appointment');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting appointment');
    });
}
</script>
</body>
</html>
